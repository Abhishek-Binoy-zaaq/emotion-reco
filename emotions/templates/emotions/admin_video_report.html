{% extends 'emotions/base.html' %}
{% load static %}

{% block title %}Video Analytics | Admin{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-slate-800">Video Analytics</h1>
            <p class="text-slate-500">Performance report for video #{{ video_id }}</p>
        </div>
        <div class="flex gap-3">
            <a href="{% url 'admin_reports' %}" class="btn-secondary flex items-center gap-2">
                <span>‚Üê</span> Back
            </a>
            <a href="{% url 'admin_dashboard' %}" class="btn-primary flex items-center gap-2">
                <span>üìä</span> Dashboard
            </a>
        </div>
    </div>

    <!-- Video Info -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
        <h2 id="videoTitle" class="text-2xl font-bold text-brand-700 mb-2">Loading...</h2>
        <p id="videoDescription" class="text-slate-500"></p>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100 text-center">
            <div id="totalSessions" class="text-3xl font-bold text-brand-600 mb-1">-</div>
            <div class="text-xs text-slate-500 uppercase font-medium tracking-wide">Total Sessions</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100 text-center">
            <div id="avgEngagement" class="text-3xl font-bold text-accent-600 mb-1">-%</div>
            <div class="text-xs text-slate-500 uppercase font-medium tracking-wide">Avg Engagement</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100 text-center">
            <div id="totalCaptures" class="text-3xl font-bold text-emerald-600 mb-1">-</div>
            <div class="text-xs text-slate-500 uppercase font-medium tracking-wide">Total Captures</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100 text-center">
            <div id="completionRate" class="text-3xl font-bold text-amber-600 mb-1">-%</div>
            <div class="text-xs text-slate-500 uppercase font-medium tracking-wide">Completion Rate</div>
        </div>
    </div>

    <!-- Chart -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
        <h3 class="font-bold text-lg text-slate-700 mb-6 flex items-center gap-2">
            <span>üé≠</span> Emotion Distribution (All Sessions)
        </h3>
        <div class="relative h-72 w-full">
            <canvas id="emotionChart"></canvas>
        </div>
    </div>

    <!-- Sessions Table -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="p-6 border-b border-gray-100">
            <h3 class="font-bold text-lg text-slate-700">Viewer Sessions</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm border-collapse">
                <thead>
                    <tr class="bg-gray-50 text-xs uppercase text-gray-500 font-semibold border-b border-gray-100">
                        <th class="px-6 py-4">ID</th>
                        <th class="px-6 py-4">User</th>
                        <th class="px-6 py-4">Date</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4 text-center">Captures</th>
                        <th class="px-6 py-4 text-center">Dominant</th>
                        <th class="px-6 py-4 text-right">Action</th>
                    </tr>
                </thead>
                <tbody id="sessionsList" class="divide-y divide-gray-100">
                    <!-- Data -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const videoId = {{ video_id }};
    let emotionChart = null;

    async function loadVideoReport() {
        try {
            // 1. Load video details
            const videoResponse = await fetch(`/api/videos/${videoId}/`);
            if (!videoResponse.ok) throw new Error("Video not found");
            const video = await videoResponse.json();

            document.getElementById('videoTitle').textContent = video.title;
            document.getElementById('videoDescription').textContent = video.description || 'No description provided';

            // 2. Load all sessions and filter
            const sessionsResponse = await fetch(`/api/sessions/`);
            const sessionsData = await sessionsResponse.json();
            const allSessions = sessionsData.results || sessionsData;
            const sessions = allSessions.filter(s => s.video_id === videoId);

            // 3. Calc Stats
            const totalSessions = sessions.length;
            const completedSessions = sessions.filter(s => s.is_completed).length;
            const completionRate = totalSessions > 0 ? (completedSessions / totalSessions * 100).toFixed(1) : 0;

            let totalCaptures = 0;
            let totalEngagement = 0;
            const allEmotions = {};

            sessions.forEach(session => {
                const summary = session.emotion_summary || {};
                totalCaptures += summary.total_captures || 0;

                // Engagement
                const counts = summary.counts || {};
                const sessionCaptures = summary.total_captures || 0;
                if (sessionCaptures > 0) {
                    const nonNeutral = Object.entries(counts)
                        .filter(([emotion]) => emotion !== 'neutral')
                        .reduce((sum, [, count]) => sum + count, 0);
                    totalEngagement += (nonNeutral / sessionCaptures * 100);
                }

                // Aggregate emotions
                Object.entries(counts).forEach(([emotion, count]) => {
                    allEmotions[emotion] = (allEmotions[emotion] || 0) + count;
                });
            });

            const avgEngagement = completedSessions > 0 ? (totalEngagement / completedSessions).toFixed(1) : 0;

            // 4. Update UI
            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('avgEngagement').textContent = avgEngagement + '%';
            document.getElementById('totalCaptures').textContent = totalCaptures;
            document.getElementById('completionRate').textContent = completionRate + '%';

            createEmotionChart(allEmotions);
            displaySessions(sessions);

        } catch (error) {
            console.error('Error:', error);
            alert('Failed to load report data');
        }
    }

    function createEmotionChart(emotions) {
        const ctx = document.getElementById('emotionChart').getContext('2d');
        const labels = Object.keys(emotions);
        const data = Object.values(emotions);
        const colors = labels.map(e => getEmotionColor(e));

        if (emotionChart) emotionChart.destroy();

        emotionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                datasets: [{
                    label: 'Captures',
                    data: data,
                    backgroundColor: colors,
                    borderRadius: 8,
                    barThickness: 40,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { borderDash: [2, 4] }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    function displaySessions(sessions) {
        const tbody = document.getElementById('sessionsList');

        if (!sessions || sessions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-slate-400">No sessions recorded yet</td></tr>';
            return;
        }

        tbody.innerHTML = sessions.map(s => {
            const summary = s.emotion_summary || {};
            return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 font-mono text-xs text-slate-500">#${s.session_id}</td>
                    <td class="px-6 py-4 font-medium text-slate-800">${s.user_name || 'Unknown'}</td>
                    <td class="px-6 py-4 text-slate-500">${new Date(s.started_at).toLocaleDateString()}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.is_completed ? 'bg-green-100 text-green-800' : 'bg-amber-100 text-amber-800'}">
                            ${s.is_completed ? 'Completed' : 'In Progress'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center font-medium">${summary.total_captures || 0}</td>
                    <td class="px-6 py-4 text-center capitalize">
                         ${summary.dominant_emotion ?
                    `<span class="px-2 py-1 bg-slate-100 rounded text-xs text-slate-700 font-medium">${summary.dominant_emotion}</span>`
                    : '-'}
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button class="text-brand-600 hover:text-brand-800 font-medium text-sm hover:underline" 
                            onclick="window.open('/admin/session-report/${s.session_id}/', '_blank')">
                            View Report
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function getEmotionColor(emotion) {
        const colors = {
            'happy': '#FFD700', 'sad': '#3B82F6', 'angry': '#EF4444',
            'surprise': '#EC4899', 'fear': '#8B5CF6', 'disgust': '#10B981', 'neutral': '#9CA3AF'
        };
        return colors[emotion] || '#94a3b8';
    }

    loadVideoReport();
</script>
{% endblock %}