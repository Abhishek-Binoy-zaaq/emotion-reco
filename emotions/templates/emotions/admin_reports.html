{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aggregate Reports</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/emotions/css/admin-common.css">
    <style>
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            height: 400px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <h1>üìà Aggregate Reports</h1>
        <div class="navbar-right">
            <a href="{% url 'admin_dashboard' %}">Dashboard</a>
            <a href="{% url 'logout' %}">Logout</a>
        </div>
    </div>

    <div class="container">
        <h2>Overall Statistics</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalSessions">0</div>
                <div class="stat-label">Total Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalCaptures">0</div>
                <div class="stat-label">Total Captures</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalVideos">0</div>
                <div class="stat-label">Videos</div>
            </div>
        </div>

        <h2>Emotion Distribution</h2>
        <div class="chart-container">
            <canvas id="emotionChart"></canvas>
        </div>

        <h2>Top Videos</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Video</th>
                        <th>Sessions</th>
                        <th>Avg Engagement</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="topVideos"></tbody>
            </table>
        </div>

        <h2>All Sessions</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Video</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Captures</th>
                        <th>Dominant Emotion</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="allSessions"></tbody>
            </table>
        </div>
    </div>

    <script>
        let emotionChart = null;

        async function loadReport() {
            try {
                const response = await fetch('/api/sessions/aggregate_report/');
                const data = await response.json();

                document.getElementById('totalSessions').textContent = data.total_sessions;
                document.getElementById('totalCaptures').textContent = data.total_captures;
                document.getElementById('totalUsers').textContent = data.total_users;
                document.getElementById('totalVideos').textContent = data.total_videos;

                createEmotionChart(data.emotion_distribution);
                displayTopVideos(data.popular_videos);
            } catch (error) {
                console.error('Error loading report:', error);
            }
        }

        function createEmotionChart(emotionData) {
            const ctx = document.getElementById('emotionChart').getContext('2d');

            const labels = Object.keys(emotionData);
            const data = Object.values(emotionData);
            const colors = labels.map(e => getEmotionColor(e));

            if (emotionChart) emotionChart.destroy();

            emotionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function displayTopVideos(videos) {
            const tbody = document.getElementById('topVideos');
            tbody.innerHTML = videos.map(v => `
                <tr>
                    <td>${v.title}</td>
                    <td>${v.sessions}</td>
                    <td>${v.engagement}%</td>
                    <td><button class="btn" onclick="viewVideoReport(${v.id})">üìä View Details</button></td>
                </tr>
            `).join('');
        }

        async function loadAllSessions() {
            try {
                const response = await fetch('/api/sessions/');
                const data = await response.json();
                const sessions = data.results || data;

                const tbody = document.getElementById('allSessions');
                if (!sessions || sessions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No sessions found</td></tr>';
                    return;
                }

                tbody.innerHTML = sessions.map(s => {
                    const summary = s.emotion_summary || {};
                    return `
                        <tr>
                            <td>${s.id}</td>
                            <td>${s.user_name || 'Unknown'}</td>
                            <td>${s.video_title || 'Unknown'}</td>
                            <td>${new Date(s.started_at).toLocaleDateString()}</td>
                            <td><span style="color: ${s.is_completed ? '#28a745' : '#ffc107'}">${s.is_completed ? '‚úì Completed' : '‚è∏ Incomplete'}</span></td>
                            <td>${summary.total_captures || 0}</td>
                            <td>${summary.dominant_emotion || 'N/A'}</td>
                            <td><button class="btn" onclick="viewSessionReport(${s.id})">üìä View</button></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        function viewSessionReport(sessionId) {
            window.open(`/report/${sessionId}/`, '_blank');
        }

        function viewVideoReport(videoId) {
            window.open(`/admin/video-report/${videoId}/`, '_blank');
        }

        function getEmotionColor(emotion) {
            const colors = {
                'happy': '#FFD700', 'sad': '#4169E1', 'angry': '#DC143C',
                'surprise': '#FF69B4', 'fear': '#9370DB', 'disgust': '#32CD32', 'neutral': '#A9A9A9'
            };
            return colors[emotion] || '#667eea';
        }

        loadReport();
        loadAllSessions();
    </script>
</body>

</html>