{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/emotions/css/admin-common.css">
    <style>
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            height: 400px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 10px;
        }

        .video-info {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .video-title {
            font-size: 2em;
            color: #667eea;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <h1>üìä Video Analytics Report</h1>
        <div class="navbar-right">
            <a href="{% url 'admin_reports' %}">Back to Reports</a>
            <a href="{% url 'admin_dashboard' %}">Dashboard</a>
        </div>
    </div>

    <div class="container">
        <div class="video-info">
            <div class="video-title" id="videoTitle">Loading...</div>
            <p id="videoDescription" style="color: #666;"></p>
        </div>

        <h2>Video Statistics</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalSessions">0</div>
                <div class="stat-label">Total Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgEngagement">0%</div>
                <div class="stat-label">Avg Engagement</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalCaptures">0</div>
                <div class="stat-label">Total Captures</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completionRate">0%</div>
                <div class="stat-label">Completion Rate</div>
            </div>
        </div>

        <h2>Emotion Distribution Across All Sessions</h2>
        <div class="chart-container">
            <canvas id="emotionChart"></canvas>
        </div>

        <h2>Session List</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Session ID</th>
                        <th>User</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Captures</th>
                        <th>Dominant Emotion</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sessionsList"></tbody>
            </table>
        </div>
    </div>

    <script>
        const videoId = {{ video_id }};
        let emotionChart = null;

        async function loadVideoReport() {
            try {
                // Load video details
                const videoResponse = await fetch(`/api/videos/${videoId}/`);
                const video = await videoResponse.json();

                document.getElementById('videoTitle').textContent = video.title;
                document.getElementById('videoDescription').textContent = video.description || 'No description';

                // Load all sessions and filter by video
                const sessionsResponse = await fetch(`/api/sessions/`);
                const sessionsData = await sessionsResponse.json();
                const allSessions = sessionsData.results || sessionsData;
                const sessions = allSessions.filter(s => s.video === videoId);

                // Calculate statistics
                const totalSessions = sessions.length;
                const completedSessions = sessions.filter(s => s.is_completed).length;
                const completionRate = totalSessions > 0 ? (completedSessions / totalSessions * 100).toFixed(1) : 0;

                let totalCaptures = 0;
                let totalEngagement = 0;
                const allEmotions = {};

                sessions.forEach(session => {
                    const summary = session.emotion_summary || {};
                    totalCaptures += summary.total_captures || 0;

                    // Calculate engagement for this session
                    const counts = summary.counts || {};
                    const sessionCaptures = summary.total_captures || 0;
                    if (sessionCaptures > 0) {
                        const nonNeutral = Object.entries(counts)
                            .filter(([emotion]) => emotion !== 'neutral')
                            .reduce((sum, [, count]) => sum + count, 0);
                        totalEngagement += (nonNeutral / sessionCaptures * 100);
                    }

                    // Aggregate emotions
                    Object.entries(counts).forEach(([emotion, count]) => {
                        allEmotions[emotion] = (allEmotions[emotion] || 0) + count;
                    });
                });

                const avgEngagement = completedSessions > 0 ? (totalEngagement / completedSessions).toFixed(1) : 0;

                // Update stats
                document.getElementById('totalSessions').textContent = totalSessions;
                document.getElementById('avgEngagement').textContent = avgEngagement + '%';
                document.getElementById('totalCaptures').textContent = totalCaptures;
                document.getElementById('completionRate').textContent = completionRate + '%';

                // Create emotion chart
                createEmotionChart(allEmotions);

                // Display sessions list
                displaySessions(sessions);

            } catch (error) {
                console.error('Error loading video report:', error);
            }
        }

        function createEmotionChart(emotions) {
            const ctx = document.getElementById('emotionChart').getContext('2d');

            const labels = Object.keys(emotions);
            const data = Object.values(emotions);
            const colors = labels.map(e => getEmotionColor(e));

            if (emotionChart) emotionChart.destroy();

            emotionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        label: 'Number of Captures',
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Captures'
                            }
                        }
                    }
                }
            });
        }

        function displaySessions(sessions) {
            const tbody = document.getElementById('sessionsList');

            if (!sessions || sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No sessions for this video</td></tr>';
                return;
            }

            tbody.innerHTML = sessions.map(s => {
                const summary = s.emotion_summary || {};
                return `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.user_name || 'Unknown'}</td>
                        <td>${new Date(s.started_at).toLocaleString()}</td>
                        <td><span style="color: ${s.is_completed ? '#28a745' : '#ffc107'}">${s.is_completed ? '‚úì Completed' : '‚è∏ Incomplete'}</span></td>
                        <td>${summary.total_captures || 0}</td>
                        <td>${summary.dominant_emotion || 'N/A'}</td>
                        <td><button class="btn" onclick="window.open('/report/${s.id}/', '_blank')">üìä View</button></td>
                    </tr>
                `;
            }).join('');
        }

        function getEmotionColor(emotion) {
            const colors = {
                'happy': '#FFD700', 'sad': '#4169E1', 'angry': '#DC143C',
                'surprise': '#FF69B4', 'fear': '#9370DB', 'disgust': '#32CD32', 'neutral': '#A9A9A9'
            };
            return colors[emotion] || '#667eea';
        }

        loadVideoReport();
    </script>
</body>

</html>