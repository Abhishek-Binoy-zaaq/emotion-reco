{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .report-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .summary-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .summary-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
        }

        .emotion-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .emotion-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .emotion-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            text-transform: capitalize;
        }

        .emotion-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .emotion-stat {
            text-align: center;
        }

        .emotion-stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .emotion-stat-label {
            font-size: 0.85em;
            color: #666;
        }

        .btn {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #667eea;
        }

        .timeline-container {
            margin-top: 30px;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìä Emotion Analysis Report</h1>

        <div id="loading" class="report-section loading">
            <div>Loading report data...</div>
        </div>

        <div id="reportContent" style="display: none;">
            <div class="report-section">
                <h2>üìà Session Summary</h2>
                <div class="info-box">
                    <strong>Video:</strong> <span id="videoName"></span><br>
                    <strong>Duration:</strong> <span id="videoDuration"></span><br>
                    <strong>Started:</strong> <span id="startTime"></span>
                </div>

                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-value" id="totalCaptures">0</div>
                        <div class="summary-label">Total Captures</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="detectionRate">0%</div>
                        <div class="summary-label">Detection Rate</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="dominantEmotion">-</div>
                        <div class="summary-label">Dominant Emotion</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="engagementScore">0%</div>
                        <div class="summary-label">Engagement Score</div>
                    </div>
                </div>
            </div>

            <div class="report-section">
                <h2>üé≠ Emotion Distribution</h2>
                <div class="chart-container">
                    <canvas id="emotionChart"></canvas>
                </div>
            </div>

            <div class="report-section">
                <h2>üìä Detailed Emotion Statistics</h2>
                <div id="emotionList" class="emotion-list"></div>
            </div>

            <div class="report-section">
                <h2>‚è±Ô∏è Emotion Timeline</h2>
                <div class="chart-container timeline-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <div class="report-section" style="text-align: center;">
                <a href="/" class="btn">üè† New Session</a>
                <a href="/admin/emotions/videosession/{{ session_id }}/" class="btn" target="_blank">üëÅÔ∏è View in
                    Admin</a>
            </div>
        </div>
    </div>

    <script>
        const sessionId = {{ session_id }};
        let emotionChart = null;
        let timelineChart = null;

        async function loadReport() {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/report/`);
                if (!response.ok) throw new Error('Failed to load report');

                const data = await response.json();
                displayReport(data);

            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <div style="color: #dc3545;">
                        Error loading report: ${error.message}
                    </div>
                `;
            }
        }

        function displayReport(data) {
            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('reportContent').style.display = 'block';

            // Session info
            document.getElementById('videoName').textContent = data.video_name;
            document.getElementById('videoDuration').textContent = formatTime(data.video_duration);
            document.getElementById('startTime').textContent = new Date(data.started_at).toLocaleString();

            // Summary stats
            document.getElementById('totalCaptures').textContent = data.total_captures;
            document.getElementById('detectionRate').textContent = data.detection_rate + '%';
            document.getElementById('dominantEmotion').textContent = data.dominant_emotion || 'N/A';
            document.getElementById('engagementScore').textContent = data.engagement_score + '%';

            // Emotion list
            displayEmotionList(data.emotion_stats);

            // Charts
            createEmotionChart(data.emotion_stats);
            createTimelineChart(data.emotion_timeline);
        }

        function displayEmotionList(emotionStats) {
            const container = document.getElementById('emotionList');
            container.innerHTML = '';

            const sortedEmotions = Object.entries(emotionStats)
                .sort((a, b) => b[1].count - a[1].count);

            sortedEmotions.forEach(([emotion, stats]) => {
                const emoji = getEmotionEmoji(emotion);
                const item = document.createElement('div');
                item.className = 'emotion-item';
                item.innerHTML = `
                    <div class="emotion-name">${emoji} ${emotion}</div>
                    <div class="emotion-stats">
                        <div class="emotion-stat">
                            <div class="emotion-stat-value">${stats.count}</div>
                            <div class="emotion-stat-label">Occurrences</div>
                        </div>
                        <div class="emotion-stat">
                            <div class="emotion-stat-value">${stats.percentage}%</div>
                            <div class="emotion-stat-label">Percentage</div>
                        </div>
                        <div class="emotion-stat">
                            <div class="emotion-stat-value">${stats.avg_confidence}%</div>
                            <div class="emotion-stat-label">Avg Confidence</div>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function createEmotionChart(emotionStats) {
            const ctx = document.getElementById('emotionChart').getContext('2d');

            const labels = Object.keys(emotionStats);
            const data = Object.values(emotionStats).map(s => s.percentage);
            const colors = labels.map(emotion => getEmotionColor(emotion));

            if (emotionChart) emotionChart.destroy();

            emotionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: { size: 14 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTimelineChart(timeline) {
            const ctx = document.getElementById('timelineChart').getContext('2d');

            const timestamps = timeline.map(t => t.timestamp.toFixed(1));
            const emotions = timeline.map(t => t.expression);

            // Convert emotions to numeric values for plotting
            const emotionMap = {
                'happy': 7, 'surprise': 6, 'neutral': 5, 'contempt': 4,
                'fear': 3, 'sad': 2, 'angry': 1, 'disgust': 0
            };
            const emotionValues = emotions.map(e => emotionMap[e] !== undefined ? emotionMap[e] : 4);
            const colors = emotions.map(e => getEmotionColor(e));

            if (timelineChart) timelineChart.destroy();

            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Emotion Over Time',
                        data: emotionValues,
                        borderColor: '#667eea',
                        backgroundColor: colors,
                        pointBackgroundColor: colors,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                callback: function (value) {
                                    const labels = ['Disgust', 'Angry', 'Sad', 'Fear', 'Contempt', 'Neutral', 'Surprise', 'Happy'];
                                    return labels[value] || '';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (seconds)'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const emotion = emotions[context.dataIndex];
                                    return emotion ? emotion.charAt(0).toUpperCase() + emotion.slice(1) : '';
                                }
                            }
                        }
                    }
                }
            });
        }

        function getEmotionEmoji(emotion) {
            const emojis = {
                'happy': 'üòä', 'sad': 'üò¢', 'angry': 'üò†', 'contempt': 'üòí',
                'surprise': 'üò≤', 'fear': 'üò®', 'disgust': 'ü§¢', 'neutral': 'üòê'
            };
            return emojis[emotion] || 'üò∂';
        }

        function getEmotionColor(emotion) {
            const colors = {
                'happy': '#FFD700', 'sad': '#4169E1', 'angry': '#DC143C', 'contempt': '#8B4513',
                'surprise': '#FF69B4', 'fear': '#9370DB', 'disgust': '#32CD32', 'neutral': '#A9A9A9'
            };
            return colors[emotion] || '#667eea';
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Load report on page load
        loadReport();
    </script>
</body>

</html>